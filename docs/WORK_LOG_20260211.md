# WORK LOG - 2026-02-11 (Tide VisTimeline 연동·문서)

## Scope

- VisTimeline 메인 Gantt에 Tide 가이던스 연동
- helper·tideService 테스트 및 타입/린트 정합성 유지
- 문서 최신화 (AGENTS.md, CHANGELOG)

## Implemented

### 1. VisTimeline 메인 Gantt Tide 연동

- **gantt-chart.tsx**
  - Tide 데이터 로드: `fetchTideData` + `buildTideWindows`, fail-soft
  - 드래그 시 DANGER 판정이면 가이던스 생성·표시
  - toast.warning에 Nearest SAFE + What-if(+1/+2d) 요약
  - 가이던스 UI: `data-testid="vis-tide-guidance"`
  - Preview nearest SAFE / Preview +1d·+2d 버튼 → 기존 `onDragMove(activityId, YYYY-MM-DD)` 호출

- **gantt-chart.tide-guidance.ts**
  - `composeDragTideGuidance(draggedTask, tideWindows, rule)` — 순수 helper
  - 출력: dragSafety, nearestSafe, whatIf(+1/+2d). DANGER가 아니면 null

### 2. 테스트

- **gantt-chart.tide-guidance.test.ts**
  - DANGER 시 nearest SAFE + what-if 반환
  - SAFE 시 null
  - SAFE 슬롯 없을 때 nearestSafe = null, what-if 유지

- **tideService.test.ts**
  - nearest SAFE / +1·+2 what-if 정합성 유지

### 3. 검증

- `pnpm test:run components/dashboard/__tests__/gantt-chart.tide-guidance.test.ts lib/services/__tests__/tideService.test.ts` 통과
- `pnpm exec tsc --noEmit --incremental false` 통과
- `pnpm exec eslint . --quiet` 통과

### 4. 문서

- **AGENTS.md**: 최신 작업 반영 라인에 Tide 고급 한 줄 요약 추가  
  `Tide 고급: SAFE 추천, DANGER What-if(+1/+2d), 가이던스 패널, Preview Apply 버튼.`
- **CHANGELOG.md**: VisTimeline 메인 Gantt Tide 연동 항목 추가 (Added), Tide 고급 다음 후보 정리

### 5. Reflow 의존성 cascade Preview 경로

- **dependency-cascade.ts**: 의존성 cascade 엔진 신규 추가.
- **applyShift.ts**: `applyBulkAnchors`에 전략 인자 추가, 기본 `dependency_cascade`로 전환.
- **schedule-reflow-manager.ts**: canonical preview 경로를 cascade 엔진 기반으로 교체, `meta.cascade`, missing predecessor 진단 충돌 반영.
- **page.tsx**: deprecated `reflowSchedule` 제거, Drag/What-if/Action에서 `previewScheduleReflow` 직접 호출로 통일.
- **테스트**: dependency-cascade.test.ts, schedule-preview-paths.test.ts, what-if-simulation.test.ts. tsc·eslint 통과.

### 6. TideOverlayGantt 가이던스 수동 오픈

- **DANGER 시**: 기존처럼 가이던스 패널 자동 표시.
- **비-DANGER 시**: "View guidance" 버튼(`open-tide-guidance`) 및 task 선택 UI로 패널 수동 표시. `guidancePinned`, `guidanceTaskId` 상태. 자동/수동 소스 표시, 동일 패널 렌더.
- **테스트**: TideOverlayGantt.test.tsx — 비-DANGER에서 버튼 클릭 시 패널 표시 검증. 4 tests passed.

### 7. Voyage Map View · ETA Drift

- **lib/tr/voyage-map-view.ts**: RiskBand, toRiskBand, riskColor, computeVoyageEtaDriftDays, buildVoyageRoute, isVoyageActive. Voyage 카드 hover/select + Drift 배지, Map overlay(drift>1.5 점선, active만 표시), page selectedVoyageNo/hoveredVoyageNo·selectedVoyage 파생·카드↔맵 연결. 스크린샷 보정: 카드 배지 2줄·active voyage만 경로 overlay.
- **테스트**: voyage-map-view.test.ts, MapPanel.test.tsx. tsc·MapPanel.test 통과.

### 8. 즉시 조치(Immediate Action) 체크리스트

- **3항목 고정**: 1차 항차 TR 1유닛 로드, SPMT 2세트 유지·MOB 1/26, 잔여 일정 확정 후 반영. **lib/alerts/immediate-actions.ts**: toSelectedDateKey, load/save/toggle, localStorage `tr-dashboard-immediate-actions:{YYYY-MM-DD}`, fail-soft.
- **OperationalNotice**: 체크박스·n/3 done·Go 버튼. 항목1→voyage 1+voyages, 항목2→schedule, 항목3→gantt.
- **AlertsSection** props: onSelectVoyageNo, onNavigateSection. **page.tsx**: handleNavigateSection(scrollIntoView), AlertsSection 콜백 전달.
- **테스트**: immediate-actions.test.ts, alerts.test.tsx(토글·날짜별 상태·Go payload). tsc 통과.

### 9. Ops — Release Split Deployment

- 일반/모바일 배포 경로 분리. `release/general→origin/main`, `release/mobile→mobile-origin/main` 가드레일.
- `pnpm release:general`, `pnpm release:mobile`, `pnpm release:verify`. `.husky/pre-push` 가드.
- 모바일: `trdash-mobile` Vercel, `https://trdash-mobile.vercel.app`.
- 상세: [release-history-20260211.md](ops/release-history-20260211.md), [release-split.md](ops/release-split.md).

### 10. 2모델 AI Dual-pass Intent Guard

- **route.ts**: 1차(OLLAMA_MODEL) 파싱 → 2차(OLLAMA_REVIEW_MODEL) 검증. 엄격 intent(apply_preview, set_mode, high-risk) 모호 시 `unclear` 전환.
- **What-if 추천**: `recommendations.what_if_shift_days` 자동 생성.
- **Governance 체크리스트**: `governance_checks`(CONFIRM_REQUIRED, APPLY_PREVIEW_REF, MODE_ALLOWED, HIGH_RISK_CONFIRM 등) 반환.
- **AIExplainDialog**: 모델 trace, what-if 제안, governance 체크 UI 표시.
- **파일**: route.ts, route.test.ts, ai-intent.ts, AIExplainDialog.tsx, AIExplainDialog.test.tsx.
- **검증**: AIExplainDialog 11/11, smoke:nl-intent 12/12.

### 11. FilterDrawer 모듈

- `components/dashboard/FilterDrawer.tsx` — named/default export 둘 다 제공, 모바일 UX용 필터 드로어.

### 12. AI LLM 타임아웃 · Fallback · 컨텍스트 축소

- **타임아웃**: `AI_PROVIDER_TIMEOUT_MS`(기본 9초).
- **빠른 fallback 파싱**: 응답 깨짐/타임아웃 시 자연어 규칙 파서로 즉시 intent 반환. provider 실패 시 503 대신 fallback 결과 반환.
- **컨텍스트 축소**: `AI_MAX_ACTIVITY_CONTEXT`(기본 48) — 쿼리 관련 activity만 전송.
- **검증**: Ctrl+K → AI Mode → 질의 → AI Command Review 팝업(model / What-if Suggestions / Governance Checks 표시). POST /api/nl-command → 200.

## Refs

- [CHANGELOG.md](../CHANGELOG.md)
- [AGENTS.md](../AGENTS.md)
- [TYPECHECK_AND_LINT_FAILURES.md](TYPECHECK_AND_LINT_FAILURES.md)
- [ops/release-split.md](ops/release-split.md), [ops/release-history-20260211.md](ops/release-history-20260211.md)
