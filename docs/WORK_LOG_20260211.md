# WORK LOG - 2026-02-11 (Tide VisTimeline 연동·문서)

## Scope

- VisTimeline 메인 Gantt에 Tide 가이던스 연동
- helper·tideService 테스트 및 타입/린트 정합성 유지
- 문서 최신화 (AGENTS.md, CHANGELOG)

## Implemented

### 1. VisTimeline 메인 Gantt Tide 연동

- **gantt-chart.tsx**
  - Tide 데이터 로드: `fetchTideData` + `buildTideWindows`, fail-soft
  - 드래그 시 DANGER 판정이면 가이던스 생성·표시
  - toast.warning에 Nearest SAFE + What-if(+1/+2d) 요약
  - 가이던스 UI: `data-testid="vis-tide-guidance"`
  - Preview nearest SAFE / Preview +1d·+2d 버튼 → 기존 `onDragMove(activityId, YYYY-MM-DD)` 호출

- **gantt-chart.tide-guidance.ts**
  - `composeDragTideGuidance(draggedTask, tideWindows, rule)` — 순수 helper
  - 출력: dragSafety, nearestSafe, whatIf(+1/+2d). DANGER가 아니면 null

### 2. 테스트

- **gantt-chart.tide-guidance.test.ts**
  - DANGER 시 nearest SAFE + what-if 반환
  - SAFE 시 null
  - SAFE 슬롯 없을 때 nearestSafe = null, what-if 유지

- **tideService.test.ts**
  - nearest SAFE / +1·+2 what-if 정합성 유지

### 3. 검증

- `pnpm test:run components/dashboard/__tests__/gantt-chart.tide-guidance.test.ts lib/services/__tests__/tideService.test.ts` 통과
- `pnpm exec tsc --noEmit --incremental false` 통과
- `pnpm exec eslint . --quiet` 통과

### 4. 문서

- **AGENTS.md**: 최신 작업 반영 라인에 Tide 고급 한 줄 요약 추가  
  `Tide 고급: SAFE 추천, DANGER What-if(+1/+2d), 가이던스 패널, Preview Apply 버튼.`
- **CHANGELOG.md**: VisTimeline 메인 Gantt Tide 연동 항목 추가 (Added), Tide 고급 다음 후보 정리

### 5. Reflow 의존성 cascade Preview 경로

- **dependency-cascade.ts**: 의존성 cascade 엔진 신규 추가.
- **applyShift.ts**: `applyBulkAnchors`에 전략 인자 추가, 기본 `dependency_cascade`로 전환.
- **schedule-reflow-manager.ts**: canonical preview 경로를 cascade 엔진 기반으로 교체, `meta.cascade`, missing predecessor 진단 충돌 반영.
- **page.tsx**: deprecated `reflowSchedule` 제거, Drag/What-if/Action에서 `previewScheduleReflow` 직접 호출로 통일.
- **테스트**: dependency-cascade.test.ts, schedule-preview-paths.test.ts, what-if-simulation.test.ts. tsc·eslint 통과.

### 6. TideOverlayGantt 가이던스 수동 오픈

- **DANGER 시**: 기존처럼 가이던스 패널 자동 표시.
- **비-DANGER 시**: "View guidance" 버튼(`open-tide-guidance`) 및 task 선택 UI로 패널 수동 표시. `guidancePinned`, `guidanceTaskId` 상태. 자동/수동 소스 표시, 동일 패널 렌더.
- **테스트**: TideOverlayGantt.test.tsx — 비-DANGER에서 버튼 클릭 시 패널 표시 검증. 4 tests passed.

### 7. Voyage Map View · ETA Drift

- **lib/tr/voyage-map-view.ts**: RiskBand, toRiskBand, riskColor, computeVoyageEtaDriftDays, buildVoyageRoute, isVoyageActive. Voyage 카드 hover/select + Drift 배지, Map overlay(drift>1.5 점선, active만 표시), page selectedVoyageNo/hoveredVoyageNo·selectedVoyage 파생·카드↔맵 연결. 스크린샷 보정: 카드 배지 2줄·active voyage만 경로 overlay.
- **테스트**: voyage-map-view.test.ts, MapPanel.test.tsx. tsc·MapPanel.test 통과.

### 8. 즉시 조치(Immediate Action) 체크리스트

- **3항목 고정**: 1차 항차 TR 1유닛 로드, SPMT 2세트 유지·MOB 1/26, 잔여 일정 확정 후 반영. **lib/alerts/immediate-actions.ts**: toSelectedDateKey, load/save/toggle, localStorage `tr-dashboard-immediate-actions:{YYYY-MM-DD}`, fail-soft.
- **OperationalNotice**: 체크박스·n/3 done·Go 버튼. 항목1→voyage 1+voyages, 항목2→schedule, 항목3→gantt.
- **AlertsSection** props: onSelectVoyageNo, onNavigateSection. **page.tsx**: handleNavigateSection(scrollIntoView), AlertsSection 콜백 전달.
- **테스트**: immediate-actions.test.ts, alerts.test.tsx(토글·날짜별 상태·Go payload). tsc 통과.

## Refs

- [CHANGELOG.md](../CHANGELOG.md)
- [AGENTS.md](../AGENTS.md)
- [TYPECHECK_AND_LINT_FAILURES.md](TYPECHECK_AND_LINT_FAILURES.md)
