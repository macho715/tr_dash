name: dependency-maintenance

on:
  schedule:
    - cron: '0 1 * * 1'
  workflow_dispatch:

jobs:
  audit:
    name: audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Run production audit
        run: pnpm audit --prod --audit-level=high

  outdated-report:
    name: outdated-report
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build outdated report
        run: |
          mkdir -p reports
          pnpm outdated > reports/pnpm-outdated.txt || true
      - name: Upload outdated artifact
        uses: actions/upload-artifact@v4
        with:
          name: pnpm-outdated-report
          path: reports/pnpm-outdated.txt
          retention-days: 14
